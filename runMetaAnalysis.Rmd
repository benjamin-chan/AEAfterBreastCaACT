---
title: "Long term adverse events after breast cancer adjuvant chemotherapy"
author: "Benjamin Chan"
output:
  html_document:
    toc: true
    keep_md: true
---

Last update: `r paste(Sys.time())`

R version: `r R.version.string`


# Using random-effects model

Load required packages

```{r}
require(metafor)
# require(lme4)
```

Recreate the analysis from Nelson (2009); Screening for Breast Cancer: An Update for the U.S. Preventive Services Task Force; Ann Intern Med. 2009;151:727-737.

Here's the dataset from the figure on page 730.

```{r MakeData}
study <- c('AGE', 'CNBSS-1', 'HIP', 'Gothenburg', 'Stockholm', 'Malmo', 'Kopparberg', 'Ostergotland')
yInt   <- c(    105,    105,     64,     34,     34,     53,     22,     31)
nInt   <- c(  53884,  25214,  13740,  11724,  14303,  13568,   9582,  10285)
pyInt  <- c( 578390, 282606, 192360,     NA, 203000, 184000, 124566, 172000)
yCntl  <- c(    251,    108,     82,     59,     13,     66,     16,     30)
nCntl  <- c( 106956,  25216,  13740,  14217,   8021,  12279,   5031,  10459)
pyCntl <- c(1149380, 282575, 192360,     NA, 117000, 160000,  65403, 176000)
n <- 10000
rateInt  <- n * yInt  / nInt
rateCntl <- n * yCntl / nCntl
rr <- rateInt / rateCntl
rd <- rateInt - rateCntl
nns <- 1 / ((yCntl / nCntl) - (yInt / nInt))
D <- data.frame(study,
                yInt , nInt , pyInt , rateInt ,
                yCntl, nCntl, pyCntl, rateCntl,
                rr, rd, nns)
D
```

Fit a random effects model for the relative risk.

```{r FitModelRR}
RR <- rma(measure="RR", data=D, ai=yInt, n1i=nInt, ci=yCntl, n2i=nCntl)
summary(RR)
predict(RR, transf=exp)
```

Plot model diagnostics.

```{r ModelDiagnosticsRR}
plot(RR)
```

Plot a L'Abbe plot.

```{r LAbbePlotRR}
labbe(RR)
```

Plot summary forest plot.

```{r ForestPlotRR}
forest(RR, slab=study, transf=exp, ref=1)
```

Fit a random effects model for the relative difference.

```{r FitModelRD}
RD <- rma(measure="RD", data=D, ai=yInt, n1i=nInt, ci=yCntl, n2i=nCntl)
summary(RD)
predict(RD)
```

Plot model diagnostics.

```{r ModelDiagnosticsRD}
plot(RD)
```

Plot a L'Abbe plot.

```{r LAbbePlotRD}
labbe(RD)
```

Plot summary forest plot.

```{r ForestPlotRD}
forest(RD, slab=study, digits=4)
```


# Using JAGS

Load `R2jags`.

```{r}
require(R2jags, quietly=TRUE)
```

Specify the model using JAGS syntax.
Write the model to a text file.

```{r}
cat("
model
{
  for( i in 1 : n ) {
    z[i] ~ dnorm(0, 1)
    logit(pInt[i] ) <- alpha + beta + sigma * z[i]
    logit(pCntl[i]) <- alpha        + sigma * z[i]
    yInt[i]  ~ dbin(pInt[i] , nInt[i] )
    yCntl[i] ~ dbin(pCntl[i], nCntl[i])
  }
  alpha ~ dnorm(-5.0, 1.0E-1)
  beta  ~ dnorm(0.0, 1.0E-1)
  sigma ~ dnorm( 0.5, 1.0E-1) I(0, )
  # sigma ~ dgamma(0.001, 0.001)
}
",
file="modelMetaAnalysis.txt")
```

Prepare the data for JAGS.
`R2jags` requires the data object to be a list.

```{r}
DJags <- list(n=nrow(D), yInt=D$yInt, nInt=D$nInt, yCntl=D$yCntl, nCntl=D$nCntl)
```

Initialize the parameters.

```{r}
inits <- function() {list("alpha"=0, "beta"=0, "sigma"=0, "z"=rep(0, nrow(D)))}
```

Specify the parameters to track.

```{r}
params <- c("alpha", "beta", "sigma")
```

Set the random number seed.

```{r}
set.seed(as.numeric(as.Date("2014-08-27")))
```

Run the model.

```{r}
system.time(M <- jags(DJags, inits, params, model.file="modelMetaAnalysis.txt", n.iter=100000))
```

I can't figure out what's wrong with `jags.parallel`.
It returns this message,

> `Error in get(name, envir = envir) : invalid first argument`

```{r, eval=FALSE}
M <- jags.parallel(DJags, inits, params, model.file="modelMetaAnalysis.txt")
```

Check for convergence.
The `r M$BUGSoutput$n.chains` MCMC chains should overlap and not diverge.

```{r mcmcConvergence}
Mmcmc <- as.mcmc(M)
xyplot(Mmcmc, alpha=1/M$BUGSoutput$n.chains)
```

Show the model output.

```{r mcmcOutput}
M
densityplot(Mmcmc)
```
